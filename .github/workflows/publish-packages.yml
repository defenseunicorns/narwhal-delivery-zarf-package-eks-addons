name: release-packages

on:
  workflow_dispatch:
  # trigger on push to main branch when a yaml file under packages directory is changed
  push:
    branches:
      - "main"
    paths:
      - "packages/**/*.y*ml"

jobs:
  changed-files:
    name: Get changed files
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.changed-files.outputs.zarf_all_changed_files }}
    steps:
      - name: Checkout
        uses: actions/checkout@a5ac7e51b41094c92402da3b24376905380afc29 # v4
        with:
          fetch-depth: 0
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@1754cd4b9e661d1f0eced3b33545a8d8b3bc46d8 # v44
        with:
          matrix: true
          files_yaml: |
            zarf:
              - '**.{yaml,yml}'
              - '**/*.{yaml,yml}'
          path: packages/ # only look in the packages directory
          dir_names: true # just give the directory names
      - name: List all changed files
        run: echo '${{ steps.changed-files.outputs.zarf_all_changed_files }}'

  publish-packages:
    name: Run Matrix Job
    runs-on: ubuntu-latest
    needs: [changed-files]
    if: ${{ needs.changed-files.outputs.matrix != '[]' }}
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        zarf-package: ${{ fromJSON(needs.changed-files.outputs.matrix) }}
      max-parallel: 10
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@a5ac7e51b41094c92402da3b24376905380afc29 # v4

      - name: Environment setup
        uses: ./.github/actions/setup
        with:
          registry1Username: ${{ secrets.IRON_BANK_ROBOT_USERNAME }}
          registry1Password: ${{ secrets.IRON_BANK_ROBOT_PASSWORD }}
          ghToken: ${{ secrets.GITHUB_TOKEN }}

      - name: publish ${{ matrix.zarf-package }} zarf package
        run: |
          ZARF_PACKAGE_NAME=${{ matrix.zarf-package }} uds run create-and-publish-single-zarf-package-with-all-architectures

      - name: Save logs
        if: always()
        uses: defenseunicorns/uds-core/.github/actions/save-logs@main
        with:
          suffix: ${{ matrix.zarf-package }}-${{ github.run_id }}-${{ github.run_attempt }}
